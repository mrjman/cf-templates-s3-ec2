---
AWSTemplateFormatVersion: "2010-09-09"

Description: >
  VPC Endpoint for S3 bucket

Metadata:
  Authors:
    Description: Mondo Robot
Parameters:
  RouteTableIds:
    Description: The route table ids to associated this endpoint to
    Type: CommaDelimitedList
  S3Bucket:
    Description: '[Optional] The S3 bucket to allow access to'
    Type: String
  VpcId:
    Description: The VPC to connect the endpoint to
    Type: AWS::EC2::VPC::Id

Resources:
  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal: '*'
            Action:
              - 's3:DeleteObjectTagging'
              - 's3:ListBucketMultipartUploads'
              - 's3:DeleteObjectVersion'
              - 's3:ListBucket'
              - 's3:DeleteObjectVersionTagging'
              - 's3:GetBucketAcl'
              - 's3:ListMultipartUploadParts'
              - 's3:PutObject'
              - 's3:GetObjectAcl'
              - 's3:GetObject'
              - 's3:AbortMultipartUpload'
              - 's3:DeleteObject'
              - 's3:GetBucketLocation'
              - 's3:PutObjectAcl'
            Resource:
              - !Sub 'arn:aws:s3:::${S3Bucket}'
              - !Sub 'arn:aws:s3:::${S3Bucket}/*'
          - Effect: Allow
            Action:
              - 's3:HeadBucket'
            Resource: '*'
      RouteTableIds: !Split [',', !Ref RouteTableIds ]
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      VpcId: !Ref VpcId
Outputs:
  StackName:
    Description: Stack name
    Value: !Sub '${AWS::StackName}'
  Endpoint:
    Description: The VPC endpoint to S3
    Value: !Ref S3Endpoint
    Export:
      Name: !Sub '${AWS::StackName}-S3Endpoint'
